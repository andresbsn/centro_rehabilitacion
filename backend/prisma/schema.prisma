generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SeguimientoTipo {
  KINESIOLOGIA
  GIMNASIO
  GENERAL
  OTRO
}

enum TurnoEstado {
  RESERVADO
  CONFIRMADO
  ASISTIO
  CANCELADO
  AUSENTE
}

enum CoseguroTipo {
  COSEGURO1
  COSEGURO2
}

enum FormaPago {
  EFECTIVO
  TRANSFERENCIA
  DEBITO
  CREDITO
  OTRO
}

model Role {
  id    String @id @default(cuid())
  name  String @unique
  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String
  nombre       String

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  seguimientos          Seguimiento[]
  turnos                Turno[]               @relation("TurnoProfesional")
  turnosCobrados        Turno[]               @relation("TurnoCobradoPor")
  pagosGimnasioCobrados PagoMensualGimnasio[] @relation("PagoGimnasioCobradoPor")
  turnoHistoriales      TurnoHistorial[]      @relation("TurnoHistorialUsuario")
  auditorias            Auditoria[]           @relation("AuditoriaUsuario")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ObraSocial {
  id            String  @id @default(cuid())
  nombre        String
  plan          String?
  observaciones String?

  coseguroTipo CoseguroTipo?

  pacientes PacienteObraSocial[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nombre, plan])
}

model ConfiguracionCoseguros {
  id String @id

  coseguro1 Int @default(0)
  coseguro2 Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PagoMensualGimnasio {
  id String @id @default(cuid())

  pacienteId String
  paciente   Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  yearMonth String
  importe   Int    @default(0)

  formaPago FormaPago?

  cobrado      Boolean   @default(false)
  cobradoAt    DateTime?
  cobradoPorId String?
  cobradoPor   User?     @relation("PagoGimnasioCobradoPor", fields: [cobradoPorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pacienteId, yearMonth])
  @@index([yearMonth])
}

model OrdenKinesiologia {
  id String @id @default(cuid())

  pacienteId String
  paciente   Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  numero          Int
  cantidadSesiones Int

  turnos Turno[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pacienteId, numero])
  @@index([pacienteId])
  @@index([numero])
}

model Paciente {
  id                 String   @id @default(cuid())
  nombre             String
  apellido           String
  dni                String   @unique
  fechaNacimiento    DateTime
  telefono           String
  email              String?
  direccion          String
  contactoEmergencia String
  activo             Boolean  @default(true)

  obraSocial             PacienteObraSocial?
  seguimientos           Seguimiento[]
  turnos                 Turno[]
  pagosMensualesGimnasio PagoMensualGimnasio[]
  ordenesKinesiologia    OrdenKinesiologia[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([apellido])
  @@index([dni])
  @@index([telefono])
}

model PacienteObraSocial {
  id           String @id @default(cuid())
  pacienteId   String @unique
  obraSocialId String

  numeroAfiliado String
  observaciones  String?

  paciente   Paciente   @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  obraSocial ObraSocial @relation(fields: [obraSocialId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Especialidad {
  id               String  @id @default(cuid())
  nombre           String  @unique
  duracionTurnoMin Int     @default(30)
  activa           Boolean @default(true)

  turnos Turno[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Seguimiento {
  id String @id @default(cuid())

  pacienteId String
  paciente   Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  profesionalId String
  profesional   User   @relation(fields: [profesionalId], references: [id])

  fecha DateTime        @default(now())
  tipo  SeguimientoTipo
  texto String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pacienteId, fecha])
  @@index([tipo])
}

model Turno {
  id String @id @default(cuid())

  pacienteId String
  paciente   Paciente @relation(fields: [pacienteId], references: [id])

  especialidadId String
  especialidad   Especialidad @relation(fields: [especialidadId], references: [id])

  ordenKinesiologiaId String?
  ordenKinesiologia   OrdenKinesiologia? @relation(fields: [ordenKinesiologiaId], references: [id])
  sesionNro           Int?

  profesionalId String?
  profesional   User?   @relation("TurnoProfesional", fields: [profesionalId], references: [id])

  startAt DateTime
  endAt   DateTime

  estado TurnoEstado @default(RESERVADO)
  notas  String?

  importeCoseguro Int       @default(0)
  cobrado         Boolean   @default(false)
  cobradoAt       DateTime?
  cobradoPorId    String?
  cobradoPor      User?     @relation("TurnoCobradoPor", fields: [cobradoPorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  historial TurnoHistorial[]

  @@index([especialidadId, startAt])
  @@index([profesionalId, startAt])
  @@index([pacienteId, startAt])
}

model TurnoHistorial {
  id String @id @default(cuid())

  turnoId String
  turno   Turno  @relation(fields: [turnoId], references: [id], onDelete: Cascade)

  estadoAnterior TurnoEstado?
  estadoNuevo    TurnoEstado

  usuarioId String
  usuario   User   @relation("TurnoHistorialUsuario", fields: [usuarioId], references: [id])

  fecha DateTime @default(now())

  @@index([turnoId])
  @@index([fecha])
}

model Auditoria {
  id String @id @default(cuid())

  accion   String
  entidad  String
  entidadId String?

  usuarioId String?
  usuario   User?   @relation("AuditoriaUsuario", fields: [usuarioId], references: [id])

  datos Json?

  ip String?

  createdAt DateTime @default(now())

  @@index([entidad, entidadId])
  @@index([usuarioId])
  @@index([createdAt])
}
